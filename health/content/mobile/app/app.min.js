'use strict';
//=======================================App配置==========================================
(function() {
    angular
        .module("myApp", ['ui.router', 'ngTouch']);

    window.myApp = angular.module("myApp");

})();
(function() {
    // injector
    myApp
        .run(run)
        .config(config);

    // run.$inject＝['$rootScope', '$state', '$stateParams'];

    function run($rootScope, $state, $stateParams) {
        $rootScope.$state = $state;
        $rootScope.$stateParams = $stateParams;
    }

    function config($stateProvider, $urlRouterProvider, $httpProvider, $compileProvider) {

        // 去除link unsafe  
        $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|coui|dachenappdoctor|dachenapppatient):/);

        //=================================http请求配置========================================
        $httpProvider.defaults.transformRequest = function(obj) {
            var str = [];
            for (var p in obj) {
                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            }
            return str.join("&");
        };
        $httpProvider.defaults.headers.post = {
            'Content-Type': 'application/x-www-form-urlencoded'
        };


        // =================================路由配置===========================================
        // $urlRouterProvider.when("", "/care_plan");

        $stateProvider
        // 测试
            .state("test", {
                // abstract: true,
                title: '测试',
                url: "/test",
                views: {
                    '': {
                        templateUrl: "app/components/test/home.html"
                    },
                    'footer@test': {
                        template: "<div>footer</div>"
                    }
                }
            })
            .state("test.page", {
                url: "/page",
                views: {
                    '': {
                        templateUrl: "app/components/test/1.html"
                    },
                    'pageFooter@test.page': {
                        template: "<div>pageFooter</div>",
                        controller: function() {
                            // console.log(myApp.api);
                        }
                    }
                }
            })
            // 首页
            .state("App", {
                title: "首页",
                url: "/",
                views: {
                    '': {
                        template: "首页"
                    }
                }
            })
            // 通用
            .state("common", {
                title: "通用",
                url: "/common",
                views: {
                    '': {
                        template: "<div ui-view>通用</div>"
                    }
                }
            })
            // 通用--打开App
            .state("common.openApp", {
                title: "打开App",
                url: "/openApp/{type}",
                views: {
                    '': {
                        template: "<open-app doc='#医生' pat='#患者'>loading...</openApp>",
                        // template: "<a href='dachenappdoctor://data=1'>点解</a>",
                    }
                }
            })
            //随访
            .state("Preview_follow_up", {
                title: '随访--预览',
                url: "/Preview_follow_up?access_token&careId",
                templateUrl: "app/components/follow_plan/questionnaire/previewView.html",
                controller: "PreviewFollowUpCtrl"
            })
            .state("Results_follow_up", {
                title: '随访--结果',
                url: "/Results_follow_up?access_token&careItemId",
                templateUrl: "app/components/follow_plan/questionnaire/resultsView.html",
                controller: "ResultsFollowUpCtrl"
            })
            .state("Answer_follow_up", {
                title: '随访--答题',
                url: "/Answer_follow_up?access_token&careItemId",
                templateUrl: "app/components/follow_plan/questionnaire/answerView.html",
                controller: "AnswerFollowUpCtrl"
            })
            //关怀计划
            .state("Answer_common_care_plan", {
                title: '关怀计划--答题',
                url: "/Answer_common_care_plan?access_token&dateTime&type&orderId&orderCareId",
                templateUrl: "app/components/care_plan/common/answer/answerView.html",
                controller: "AnswerCommonCtrl"
            })
            .state("Results_common_care_plan", {
                title: '关怀计划--结果',
                url: "/Results_common_care_plan?access_token&dateTime&type&orderId&userType&orderCareId",
                templateUrl: "app/components/care_plan/common/results/resultsView.html",
                controller: "ResultsCommonCtrl"
            })
            .state("Preview_illness_follow", {
                title: '病情跟踪--预览',
                url: "/Preview_illness_follow?access_token&careId",
                templateUrl: "app/components/care_plan/illness_follow/previewView.html",
                controller: "PreviewIllnessFollowCtrl"
            })
            .state("Preview_live_stock", {
                title: '生活量表--预览',
                url: "/Preview_live_stock?access_token&careId",
                templateUrl: "app/components/care_plan/live_stock/previewView.html",
                controller: "PreviewLiveStockCtrl"
            })
    }
})();

// ===================================指令===================================
// =================================网页标题指令=================================
(function() {
    myApp
        .directive('updateTitle', updateTitle);

    function updateTitle($rootScope, $timeout) {
        return {
            link: function(scope, element) {
                var listener = function(event, toState) {

                    var title = '玄关健康';
                    if (toState.title) {
                        title = toState.title;
                    }

                    $timeout(function() {
                        element.text(title);
                    }, 0, false);
                };

                $rootScope.$on('$stateChangeSuccess', listener);
            }
        };
    }
})();

// =================================填空题生成器,(___)转换成 input 指令=================================
(function() {
    myApp
        .directive('strToInput', strToInput);

    function strToInput($compile) {
        return {
            scope: {
                question: '=', //
                answer: '=', //答案
            },
            link: function(scope, element, attrs) {
                scope.$watch('question', function() {
                    if (!scope.question) return;
                    var str = scope.question.replace(/\([^\)]*\)/g, " ( <input class='text-base' type='text' placeholder='答案' ng-model='answer' > ) ");
                    var reg = new RegExp("\n", "g");
                    str = str.replace(reg, "</br>");
                    var compile = $compile('<c>' + str + '</c>')(scope);
                    element.replaceWith(compile);
                    element = compile;
                })
            }
        };
    }
})();

//===================================打开App 跳转页========================
(function() {
    myApp
        .directive('openApp', openApp);

    function openApp($location, $timeout, $stateParams) {
        return {
            scope: {
                doc: '@',
                pat: '@',
                gud: '@',
            },
            template: '<div class="text-center"><p></br></br></br>Loading...</div>',
            controller: function($scope) {

                var openUrl = '#',
                    noAppdown = '/appInvite/goDownApp.html';
                // 获取url的参数
                var url = $location.url();
                var arry = url.split('?');
                var param = arry[1] || '';

                // 下载地址
                var iphoneUrl, androidUrl;

                // 打开App地址
                var openApp = {
                    doc: 'dachenappdoctor://',
                    pat: 'dachenapppatient://',
                    gud: 'dachenappguidedoctor://',
                    nur: 'dachenappnurse://'
                }
                if ($stateParams.type == 'doc') {
                    openUrl = openApp.doc + param;

                    iphoneUrl = 'http://fir.im/xgys';
                    androidUrl = 'http://fir.im/9kep';
                    noAppdown = noAppdown + '?downTye=doc';

                } else if ($stateParams.type == 'pat') {
                    openUrl = openApp.pat + param;

                    iphoneUrl = 'http://fir.im/xghz';
                    androidUrl = 'http://fir.im/rvg6';
                    noAppdown = noAppdown + '?downTye=pati';

                } else if ($stateParams.type == 'gud') {

                    openUrl = openApp.gud + param;

                } else if ($stateParams.type == 'nur') {

                    openUrl = openApp.nur + param;

                    iphoneUrl = 'http://fir.im/xghs';
                    androidUrl = iphoneUrl;
                    noAppdown = noAppdown + '?downTye=nur';
                }


                var timeout, t = 1000,
                    hasApp = true;

                setTimeout(function() {

                    if (hasApp) {}

                    // 如果没有APP
                    else {

                        // 获取访问的设备
                        var device = discernDevice();

                        //判断设备
                        if (!device)
                            return alert("暂时不支持您的设备");
                        if (device.weixin)
                            return window.location.href = noAppdown;
                        if (device.qq)
                            return window.location.href = noAppdown;
                        if (device.weibo)
                            return window.location.href = noAppdown;
                        if (device.iphone)
                            return window.location.href = iphoneUrl;
                        if (device.android)
                            return window.location.href = androidUrl;

                    }
                }, 4000)

                function testApp() {
                    var t1 = Date.now();
                    /*
                    var ifr = $('<iframe id="ifr"></iframe>')
                    ifr.attr('src', 'cloudhubaa://start?from=invite');
                    ifr.css('display','none');
                    $('body').append(ifr);
                    */
                    var ifr = document.createElement('iframe');
                    ifr.setAttribute('id', 'ifr');
                    ifr.setAttribute('src', openUrl);
                    ifr.style.display = 'none';
                    document.body.appendChild(ifr);
                    window.location.href = openUrl;

                    timeout = setTimeout(function() {
                        try_to_open_app(t1);
                    }, t);
                }

                function try_to_open_app(t1) {
                    var t2 = Date.now();
                    if (!t1 || t2 - t1 < t + 200) {
                        hasApp = false;
                    }
                }
                testApp();

                //识别设备
                function discernDevice() {
                    var user = navigator.userAgent.toLowerCase();
                    var dv = {};
                    if (user.match(/MicroMessenger/i) == "micromessenger") {
                        dv.weixin = true;
                    }
                    if (user.match(/QQ/i) == "qq") {
                        dv.qq = true;
                    }
                    if (user.match(/WeiBo/i) == "weibo") {
                        dv.weibo = true;
                    }
                    if (user.indexOf('android') != -1) {
                        dv.android = true;
                    } else if (user.indexOf('iphone') != -1) {
                        dv.iphone = true;
                    } else {
                        dv = null;
                    }
                    return dv;
                }

            },
        }
    }
})();

// =================================App 控制器=================================
(function() {
    myApp
        .controller('AppCtrl', AppCtrl)

    function AppCtrl() {

        var root = '/kangzhe/';

        // 配置接口
        myApp.api = {

            // 随访计划
            followPlan: {

                // 随访 - 查询随访患者问题详情
                // access_token    String      token
                // careItemId      Long        随访ID
                queryTemplateFollowDoctor: root + 'pack/follow/queryTemplateFollowDoctor',

                // 随访 - 记录患者答案(APP) 
                // access_token    String      token
                // careItemId      Long        随访ID
                // answers         String[]    随访ID$问题ID$问题答案 随访ID,问提ID和答案已$符号分开
                saveFollowAnswer: root + 'pack/follow/saveFollowAnswer',

                // 随访 - 查询随访患者问题与答案(WEB_H5)
                // access_token    String      token
                // careItemId      Long        患者随访ID
                viewFollowPatient: root + 'pack/follow/viewFollowPatient',
            },

            // 关怀计划
            carePlan: {

                // 关怀计划 - 根据关怀类型，关怀订单ID ，日期查询计划关怀答案或问题
                // access_token    String      token
                // dateTime        String      日期时间yyy-MM-dd
                // type            Integer     类型 查询 1：病情跟踪 3：生活量表 
                // orderId         Integer     订单ID
                // orderCareId     Integer     计划关怀ID type=3必传
                getCareQuestionList: root + 'pack/carePlan/getCareQuestionList',

                // 关怀计划 - 提交计划关怀答案_H5
                // access_token    String      token
                // type            Integer     关怀内容类型查询 1：病情跟踪，3：生活量表
                // issueAndAnswer  String[]    关怀计划明细id$问题ID$答案ID
                // dateTime        String      日期时间yyy-MM-dd
                // orderId         Integer     订单ID
                // orderCareId     Integer     计划关怀ID type=3必传
                addAnswerOrderCareScale: root + 'pack/carePlan/addAnswerOrderCareScale',

                // 关怀计划 - 查询关怀模板问题列表
                // access_token    String     token
                // careId          String     关怀计划内容ID、关怀计划病情跟踪ID
                // type            Integer    关怀内容类型查询 1：病情跟踪，2：日程提醒，3：生活量表
                findCareTemplateById: root + 'pack/care/findCareTemplateById',
            }
        }
    }


})();

// ==============================关怀计划－通用－答题服务=================================

(function() {
    myApp
        .factory('carePlanAnswerFactory', carePlanAnswerFactory);

    function carePlanAnswerFactory($http) {
        return {
            getData: getData,
            submitData: submitData
        };
        // 获取关怀计划答题题目
        function getData(param) {

            return $http.post(myApp.api.carePlan.getCareQuestionList, param)

        };
        // 提交关怀计划答题结果
        function submitData(param) {

            return $http.post(myApp.api.carePlan.addAnswerOrderCareScale, param)

        };
    }
})();

// ==============================关怀计划－通用－预览－服务=================================
(function() {
    myApp
        .factory('getPreviewDataFactory', getPreviewDataFactory);

    function getPreviewDataFactory($http) {
        return {
            getData: getData
        };
        // 获取数据
        function getData() {
            return $http.post('/kangzhe/base/getDiseaseTree', {
                    t: 1
                })
                .then(getDataComplete)
                .catch(getDataFailed);
            // 处理数据
            function getDataComplete(response) {
                return response.data;
            };
            // 检测错误
            function getDataFailed(error) {

                console.error('请求失败.' + error.data);
            };
        };
    }

})();

//================================关怀计划通用答题CtrL=============================
(function() {
    myApp
        .controller('AnswerCommonCtrl', AnswerCommonCtrl);

    function AnswerCommonCtrl($stateParams, $http, $scope, $state, carePlanAnswerFactory) {

        // 参数配置 页码（等同题号）  答案列表   问题列表
        $scope.page = 0, $scope.chooseList = [], $scope.questionlist = [];

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.dateTime) return alert("提示：缺少dateTime");
        if (!$stateParams.type) return alert("提示：缺少type");
        if (!$stateParams.orderId) return alert("提示：缺少orderId");

        // 查单个生活量表需要的参数
        var orderCareId = '';

        // 生活量表
        if ($stateParams.type == 3 || $stateParams.type == 8) {
            if (!$stateParams.orderCareId) {
                return alert("提示：缺少orderCareId");
            }
            orderCareId = $stateParams.orderCareId;
        }

        // 获取题目
        getAnswerData();

        function getAnswerData() {
            var param = {
                access_token: $stateParams.access_token,
                dateTime: $stateParams.dateTime,
                type: $stateParams.type,
                orderId: $stateParams.orderId,
                orderCareId: orderCareId || '' // 查单个生活量表需要的参数
            }
            carePlanAnswerFactory
                .getData(param)
                .then(function(rpn) {
                    if (rpn.data.resultCode === 1) {
                        if ($stateParams.type == 3) {
                            $scope.questionlist = rpn.data.data[0].answerTemplates;
                        } else {
                            $scope.questionlist = rpn.data.data;
                        }
                        console.log(rpn.data.data);
                    } else if (rpn.data.resultMsg) {
                        alert(rpn.data.resultMsg);
                    } else {
                        alert("网络错误");
                    }
                });
        };

        // 选择题是否选中状态
        $scope.isChoose = function(optionsId) {

            if (!$scope.chooseList[$scope.page]) {
                return false;
            }
            if ($scope.chooseList[$scope.page].content === optionsId) {
                return true;
            }
            return false;
        }

        // 选择选项
        $scope.choose = function(optionsId, questionId, orderCareId, score) {
            $scope.chooseList[$scope.page] = {
                orderCareId: orderCareId,
                id: questionId,
                content: optionsId,
                score: score
            };
            console.log(orderCareId);
        }

        // 提交
        $scope.submit = function() {
            var anserList = [];
            for (var i = 0; i < $scope.chooseList.length; i++) {

                // 生活量表
                if ($scope.chooseList[i].score) {
                    anserList.push($scope.chooseList[i].orderCareId + '$' + $scope.chooseList[i].id + '$' + $scope.chooseList[i].content + '$' + $scope.chooseList[i].score);
                }
                // 病情跟踪
                else {
                    anserList.push($scope.chooseList[i].orderCareId + '$' + $scope.chooseList[i].id + '$' + $scope.chooseList[i].content);
                }

            }
            // 提交答案
            var param = {
                access_token: $stateParams.access_token,
                type: $stateParams.type,
                issueAndAnswer: anserList,
                dateTime: $stateParams.dateTime,
                orderId: $stateParams.orderId,
                orderCareId: orderCareId || ''
            }
            carePlanAnswerFactory
                .submitData(param)
                .then(function(rpn) {
                    if (rpn.data.resultCode === 1) {
                        alert("提交成功");
                        $state.go('Results_common_care_plan', {
                            access_token: $stateParams.access_token,
                            dateTime: $stateParams.dateTime,
                            type: $stateParams.type,
                            orderId: $stateParams.orderId,
                            userType: 1,
                            orderCareId: orderCareId
                        });
                    } else if (rpn.data.resultMsg) {
                        alert(rpn.data.resultMsg);
                    } else {
                        alert("网络错误");
                    }
                });
        }

        // 下一题
        $scope.next = function($event) {
            // 未选择答案
            if (!$scope.chooseList[$scope.page]) {
                // alert('请回答当前问题');
                setTimeout('alert("请回答当前问题")', 250);
                return;
            }
            $scope.page = $scope.page + 1;
        }

        // 上一题
        $scope.prev = function() {
            $scope.page = $scope.page - 1;
        }
    }
})();

//================================关怀计划通用结果Ctrl=============================
(function() {
    myApp
        .controller('ResultsCommonCtrl', ResultsCommonCtrl);

    function ResultsCommonCtrl($stateParams, $http, $scope) {

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.dateTime) return alert("提示：缺少dateTime");
        if (!$stateParams.type) return alert("提示：缺少type");
        if (!$stateParams.orderId) return alert("提示：缺少orderId");
        if (!$stateParams.userType) return alert("提示：缺少userType");

        // 判断角色
        $scope.userType = $stateParams.userType;

        var orderCareId = null;
        if ($stateParams.type == 8) {
            if ($stateParams.orderCareId) {
                orderCareId = $stateParams.orderCareId;
            } else {
                return alert("提示：缺少orderCareId");
            }
        }

        // 获取题目 和 答案
        $http.post('/kangzhe/pack/carePlan/getCareQuestionList', {
            access_token: $stateParams.access_token,
            dateTime: $stateParams.dateTime,
            type: $stateParams.type,
            orderId: $stateParams.orderId,
            orderCareId: orderCareId || ''
        }).
        then(function(rpn) {
            if (rpn.data.resultCode === 1) {
                if ($stateParams.type == 3) {
                    $scope.questionlist = rpn.data.data[0].answerTemplates;
                    $scope.assessResults = rpn.data.data[0].assessResults;
                    $scope.countFraction = rpn.data.data[0].countFraction;
                } else {
                    $scope.questionlist = rpn.data.data;
                }
                console.log($scope.questionlist);
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
    }

})();

//================================关怀计划病情跟踪预览=============================
(function() {
    myApp
        .controller('PreviewIllnessFollowCtrl', PreviewIllnessFollowCtrl);

    function PreviewIllnessFollowCtrl($stateParams, $http, $scope) {

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.careId) return alert("提示：缺少careId");

        $http.post('/kangzhe/pack/care/findCareTemplateById', {
            access_token: $stateParams.access_token,
            careId: $stateParams.careId,
            type: 1
        }).
        then(function(rpn) {
            if (rpn.data.resultCode === 1) {
                $scope.data = rpn.data.data;
                console.log($scope.data);
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
    }
})();

//================================生活量表js=============================
(function() {
    myApp
        .controller('PreviewLiveStockCtrl', PreviewLiveStockCtrl);

    function PreviewLiveStockCtrl($stateParams, $http, $scope) {

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.careId) return alert("提示：缺少careId");

        $http.post('/kangzhe/pack/care/findCareTemplateById', {
            access_token: $stateParams.access_token,
            careId: $stateParams.careId,
            type: 3
        }).
        then(function(rpn) {
            if (rpn.data.resultCode === 1) {
                $scope.data = rpn.data.data;
                console.log($scope.data);
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
    }
})();

//================================随访答题=============================
(function() {
    myApp
        .controller('AnswerFollowUpCtrl', AnswerFollowUpCtrl);

    function AnswerFollowUpCtrl($stateParams, $http, $scope, $sce, $state) {
        // 参数配置 页码（等同题号）  答案列表   问题列表
        $scope.page = 0, $scope.chooseList = [], $scope.questionlist = [];

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.careItemId) return alert("提示：缺少careItemId");

        // 获取题目
        $http.post('/kangzhe/pack/follow/queryTemplateFollowDoctor', {
            access_token: $stateParams.access_token,
            careItemId: $stateParams.careItemId
        }).
        then(function(rpn) {
            console.log(rpn.data);
            if (rpn.data.resultCode === 1) {
                $scope.questionlist = rpn.data.data.caresIssues;
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
        // (___)转成输入框input ，替换换行符为 br
        $scope.toInput = function(text) {
                // text = '你(___)'
                if (!text) return;
                text = text.replace(/\([^\)]*\)/g, " ( <input class='answer form-control' type='text' style='display:inline;width:100px;' placeholder='答案' > ) ");
                var reg = new RegExp("\n", "g");
                text = text.replace(reg, "</br>");
                return $sce.trustAsHtml(text);
            }
            // 选择题是否选中状态
        $scope.isChoose = function(number) {

                if (!$scope.chooseList[$scope.page]) {
                    return false;
                }
                if ($scope.chooseList[$scope.page].content === number) {
                    return true;
                }
                return false;
            }
            // 选择选项
        $scope.choose = function(answer, questionId) {
            console.log(questionId)
            $scope.chooseList[$scope.page] = {
                id: questionId,
                content: answer
            };
        }

        // 提交
        $scope.submit = function() {
            var answers = [];
            for (var i = 0; i < $scope.chooseList.length; i++) {
                answers.push($stateParams.careItemId + '$' + $scope.chooseList[i].id + '$' + $scope.chooseList[i].content);
            }
            console.log(answers);
            // 答题
            $http.post('/kangzhe/pack/follow/saveFollowAnswer', {
                access_token: $stateParams.access_token,
                careItemId: $stateParams.careItemId,
                answers: answers
            }).
            then(function(rpn) {
                if (rpn.data.resultCode === 1) {
                    alert("提交成功");
                    // 跳转到结果页面
                    $state.go('Results_follow_up', {
                        access_token: $stateParams.access_token,
                        careItemId: $stateParams.careItemId
                    });
                } else if (rpn.data.resultMsg) {
                    alert(rpn.data.resultMsg);
                } else {
                    alert("网络错误");
                }
            });
        }

        // 下一题
        $scope.next = function() {
                // 非选择题
                if ($scope.questionlist[$scope.page].type != 2) {
                    // 未填写答案
                    if (!$scope.chooseList[$scope.page]) {
                        return alert('请回答当前问题');
                    }
                    $scope.chooseList[$scope.page].id = $scope.questionlist[$scope.page].careIssueId;
                }
                // 未选择答案
                if (!$scope.chooseList[$scope.page]) {
                    return alert('请回答当前问题');
                }
                $scope.page = $scope.page + 1;
            }
            // 上一题
        $scope.prev = function() {
            $scope.page = $scope.page - 1;
        }
    }
})();

//================================随访预览=============================
(function() {
    myApp
        .controller('PreviewFollowUpCtrl', PreviewFollowUpCtrl);

    function PreviewFollowUpCtrl($stateParams, $http, $scope, $sce) {

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.careId) return alert("提示：缺少careId");

        // 获取题目
        $http.post('/kangzhe/pack/follow/queryTemplateFollowDoctor', {
            access_token: $stateParams.access_token,
            careId: $stateParams.careId
        }).
        then(function(rpn) {
            if (rpn.data.resultCode === 1) {
                $scope.data = rpn.data.data;
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
    }
})();

//================================随访结果=============================
(function() {
    myApp
        .controller('ResultsFollowUpCtrl', ResultsFollowUpCtrl);

    function ResultsFollowUpCtrl($stateParams, $http, $scope, $sce) {

        if (!$stateParams.access_token) return alert("提示：缺少access_token");
        if (!$stateParams.careItemId) return alert("提示：缺少careItemId");
        // 获取题目
        $http.post('/kangzhe/pack/follow/viewFollowPatient', {
            access_token: $stateParams.access_token,
            careItemId: $stateParams.careItemId
        }).
        then(function(rpn) {
            console.log(rpn.data)
            if (rpn.data.resultCode === 1) {
                $scope.data = rpn.data.data;
            } else if (rpn.data.resultMsg) {
                alert(rpn.data.resultMsg);
            } else {
                alert("网络错误");
            }
        });
        $scope.toInput = function(text, answer) {
            text = text.replace(/\([^\)]*\)/g, '( <c class="color-blue" >' + answer + '</c> )');
            var reg = new RegExp("\n", "g");
            text = text.replace(reg, "</br>");
            return $sce.trustAsHtml(text);
        }
    }
})();
