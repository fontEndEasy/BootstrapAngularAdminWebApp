<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" href="common.css">
    <script type="text/javascript" src="../assets/config.js"></script>
    <title>加入我们</title>
</head>

<body style="padding: 20px 10px; background: #f1f2f4;">
    <div class="content">
        <div class="header">
            <img src="img/LOGO.png" width="36" height="36">
            <span>玄关健康医生端</span>
        </div>
        <div class="boday" id="infoBox">
            <h3 class="m-t-sm"><span id="docName">张医生</span>：您好！</h3>
            <P id="info" class="text-info m-t-xs">
            </P>
            <div class="btn clearfix m-t-xl">
                <a class="btn bg-danger cl-white btn-block fl btn-lg" id="Refused">拒绝</a>
                <a class="btn bg-success cl-white btn-block fr btn-lg" id="Agreed">同意</a>
            </div>
        </div>
        <div class="boday  p-t-xxxxl" id="success" style="display:none">
            <div class="text-center">
                <!-- <span class="cl-success font-3em">√</span> -->
                <img src="img/tick.png" height="90" width="90">
            </div>
            <div class="text-center">
                <label class="icon-text-xl" id="successText">成功加入</label>
            </div>
        </div>
        <div class="boday p-t-xxxxl" id="error" style="display:none">
            <div class="text-center">
                <!-- <span class="cl-danger font-3em">X</span> -->
                <img src="img/wrong.png" height="90" width="90">
            </div>
            <div class="text-center">
                <label class="icon-text-xl" id="errorText">成功拒绝</label>
            </div>
        </div>
    </div>
    <!-- <div class="footer l1">
        <div class="line"></div>
    </div>
    <div class="footer l2">
        <div class="line"></div>
    </div> -->
    <script type="text/javascript">
    (function() {

        //获取url参数
        var parameterArry = (function getParameter() {
            var url = location.search;
            var theRequest = {};
            if (url.indexOf('?') != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = strs.length - 1; i >= 0; i--) {
                    theRequest[strs[i].split("=")[0]] = decodeURI(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        })();

        console.log(parameterArry);
        var info = '';
        document.getElementById('docName').innerHTML = parameterArry.doctorName;
        if (parameterArry.type == 3) {
            info = parameterArry.name + "邀请您加入，加入医生集团可以开展相关集团业务。是否同意加入该集团？"
        } else {
            info = parameterArry.name + "邀请您成为管理员,您可以使用您医生账户信息登录健康伽医生集团管理系统进行相关管理操作。是否同意成为该集团管理员？"
        }
        document.getElementById('info').innerHTML = info || '';

        if (!parameterArry.type) return;

        // ajax post请求：
        var createAjax = function() {
            var xhr = null;
            try {
                //IE系列浏览器
                xhr = new ActiveXObject("microsoft.xmlhttp");
            } catch (e1) {
                try {
                    //非IE浏览器
                    xhr = new XMLHttpRequest();
                } catch (e2) {
                    window.alert("您的浏览器不支持ajax，请更换！");
                }
            }
            return xhr;
        };
        var ajax = function(conf) {
            // 初始化
            //type参数,可选
            var type = conf.type;
            //url参数，必填 
            var url = conf.url;
            //data参数可选，只有在post请求时需要
            var data = conf.data;
            //datatype参数可选    
            var dataType = conf.dataType;
            //回调函数可选
            var success = conf.success;

            if (type == null) {
                //type参数可选，默认为get
                type = "get";
            }
            if (dataType == null) {
                //dataType参数可选，默认为text
                dataType = "text";
            }
            // 创建ajax引擎对象
            var xhr = createAjax();
            // 打开
            xhr.open(type, url, true);
            // 发送
            if (type == "GET" || type == "get") {
                xhr.send(null);
            } else if (type == "POST" || type == "post") {
                xhr.setRequestHeader("content-type",
                    "application/x-www-form-urlencoded");
                xhr.send(data);
            }
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (dataType == "text" || dataType == "TEXT") {
                        if (success != null) {
                            //普通文本
                            success(xhr.responseText);
                        }
                    } else if (dataType == "xml" || dataType == "XML") {
                        if (success != null) {
                            //接收xml文档    
                            success(xhr.responseXML);
                        }
                    } else if (dataType == "json" || dataType == "JSON") {
                        if (success != null) {
                            //将json字符串转换为js对象  
                            success(eval("(" + xhr.responseText + ")"));
                        }
                    }
                }
            };
        };

        //获取dom
        var infoBox = document.getElementById("infoBox");
        var refusedBtn = document.getElementById("Refused");
        var agreedBtn = document.getElementById("Agreed");
        var successBox = document.getElementById("success");
        var errorBox = document.getElementById("error");
        var successText = document.getElementById("successText");
        var errorText = document.getElementById("errorText");

        //同意后的页面 
        function successResult(content) {
            infoBox.style.display = 'none';
            successBox.style.display = 'block';
            successText.innerHTML = content || '加入成功';
        }
        //拒绝后的页面 
        function errorResult(content) {
            infoBox.style.display = 'none';
            errorBox.style.display = 'block';
            successText.innerHTML = content || '加入失败';
        }


        //同意
        agreedBtn.addEventListener("touchstart", function() {
            postDecision('C');
        })

        //拒绝
        refusedBtn.addEventListener("touchstart", function() {
            postDecision('N');
        })

        getInviteStatus();
        // 获取邀请状态
        function getInviteStatus() {

            infoBox.style.display = 'none';

            var url = serverApiRoot + "group/user/getInviteStatus";
            var data = 'id=' + parameterArry.id + '&type=' + parameterArry.type;
            console.log(url + data);

            ajax({
                type: "post",
                url: url,
                data: data,
                dataType: "json",
                success: function(data) {

                    if (data && data.resultCode === 1) {

                        if (data.data && data.data.status == 'C') {
                            if (parameterArry.type == 3) {
                                infoBox.innerHTML = '<p class="text-center text-info">您已成功加入' + data.data.name + '</p>';
                            } else if (parameterArry.type == 2) {
                                infoBox.innerHTML = '<p class="text-center text-info">您已成功成为' + data.data.name + '管理员</p>';
                            }

                        }
                        infoBox.style.display = 'block';

                    } else {
                        console.warn(data);
                    }
                }
            });
        };


        //发送请求
        function postDecision(status) {

            if (!(parameterArry.id && parameterArry.type && status)) {
                return alert('提交的参数异常！');
            }

            var url = serverApiRoot + "group/user/confirmByJoin";
            var data = 'id=' + parameterArry.id + '&type=' + parameterArry.type + '&status=' + status;
            console.log(url + data);
            ajax({
                type: "post",
                url: url,
                data: data,
                dataType: "json",
                success: function(data) {
                    console.log(data);
                    if (data.resultCode === 1 && status == 'C') {
                        return successResult(data.data);
                    }
                    if (data.resultCode === 1 && status == 'N') {
                        return errorResult(data.data);
                    }
                    if (data.resultCode === 0) {
                        return alert(data.resultMsg);
                    }
                    return alert(data.resultMsg);
                }
            })
        }
    })()
    </script>
</body>

</html>
